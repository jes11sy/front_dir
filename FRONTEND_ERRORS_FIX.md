# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ Frontend Director

## –î–∞—Ç–∞: 29 –¥–µ–∫–∞–±—Ä—è 2025

## –ü—Ä–æ–±–ª–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã

### 1. ReferenceError: returnNaN is not defined
**–ü—Ä–∏—á–∏–Ω–∞**: –ü—Ä–æ–±–ª–µ–º–∞ —Å –º–∏–Ω–∏—Ñ–∏–∫–∞—Ü–∏–µ–π/–∫–æ–º–ø–∏–ª—è—Ü–∏–µ–π Next.js 15.5.5

**–†–µ—à–µ–Ω–∏–µ**: 
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –≥–ª–æ–±–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ `layout.tsx`
- –£–ª—É—á—à–µ–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è webpack –≤ `next.config.js`

### 2. EACCES: permission denied, open '/dev/lrt' –∏ '//lrt'
**–ü—Ä–∏—á–∏–Ω–∞**: –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—É—Å—Ç—ã—Ö –∏–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã—Ö fileKey –≤ `s3-utils.ts`

**–†–µ—à–µ–Ω–∏–µ**:
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –∏ –æ—á–∏—Å—Ç–∫–∞ `fileKey` –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
- –î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ `null`, `undefined`, –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
- –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤ `getSignedUrl()`

### 3. ECONNREFUSED ::1:3002
**–ü—Ä–∏—á–∏–Ω–∞**: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π API_BASE_URL –≤ `s3-utils.ts` (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è `localhost:3001` –≤–º–µ—Å—Ç–æ production URL)

**–†–µ—à–µ–Ω–∏–µ**:
- –ò–∑–º–µ–Ω–µ–Ω –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π `API_BASE_URL` —Å `http://localhost:3001/api/v1` –Ω–∞ `https://api.test-shem.ru/api/v1`
- –¢–µ–ø–µ—Ä—å —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –æ—Å–Ω–æ–≤–Ω—ã–º `api.ts`

### 4. –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ SIGTERM –∏ uncaughtException
**–ü—Ä–∏—á–∏–Ω–∞**: –ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ –∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–Ω—ã–µ –ø—Ä–æ–º–∏—Å—ã

**–†–µ—à–µ–Ω–∏–µ**:
- –î–æ–±–∞–≤–ª–µ–Ω—ã –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ `error` –∏ `unhandledrejection` –≤ `layout.tsx`
- –£–ª—É—á—à–µ–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è webpack —Å fallback –¥–ª—è node –º–æ–¥—É–ª–µ–π

## –í–Ω–µ—Å–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. `src/lib/s3-utils.ts` - –£–ü–†–û–©–ï–ù–û! üéâ
```typescript
// –î–û: –°–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å API –∑–∞–ø—Ä–æ—Å–∞–º–∏ –∏ fallback
const API_BASE_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3001/api/v1';

export async function getSignedUrl(fileKey: string, expiresIn: number = 3600): Promise<string> {
  // 50+ —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞ —Å fetch, try-catch, fallback...
}

// –ü–û–°–õ–ï: –ü—Ä–æ—Å—Ç–∞—è –ø—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ S3
const S3_BASE_URL = process.env.NEXT_PUBLIC_S3_BASE_URL || 'https://s3.twcstorage.ru/f7eead03-crmfiles';

export async function getSignedUrl(fileKey: string): Promise<string> {
  if (!fileKey || typeof fileKey !== 'string' || fileKey.trim() === '') {
    throw new Error('File key is required');
  }

  const cleanFileKey = fileKey.trim();
  
  // –ï—Å–ª–∏ —É–∂–µ –ø–æ–ª–Ω—ã–π URL - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
  if (cleanFileKey.startsWith('http://') || cleanFileKey.startsWith('https://')) {
    return cleanFileKey;
  }

  // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É –Ω–∞ S3
  return `${S3_BASE_URL}/${cleanFileKey}`;
}
```

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚úÖ –£–±—Ä–∞–Ω–∞ –≤—Å—è –ª–æ–≥–∏–∫–∞ —Å API –∑–∞–ø—Ä–æ—Å–∞–º–∏ (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
- ‚úÖ –£–±—Ä–∞–Ω—ã fallback –∏ try-catch (–Ω–µ –Ω—É–∂–Ω—ã)
- ‚úÖ –£–ø—Ä–æ—â–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `getSignedUrls()` - —Ç–µ–ø–µ—Ä—å –ø—Ä–æ—Å—Ç–æ —Ü–∏–∫–ª
- ‚úÖ –£–±—Ä–∞–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `expiresIn` (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä—è–º—ã—Ö —Å—Å—ã–ª–æ–∫)
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ **"The string did not match the expected pattern"**

### 2. `src/app/layout.tsx`
–î–æ–±–∞–≤–ª–µ–Ω—ã –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ—à–∏–±–æ–∫:
```typescript
<Script id="error-handler" strategy="beforeInteractive">
  {`
    // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫
    window.addEventListener('error', function(event) {
      console.error('Global error caught:', event.error);
      event.preventDefault();
    });
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –ø—Ä–æ–º–∏—Å–æ–≤
    window.addEventListener('unhandledrejection', function(event) {
      console.error('Unhandled promise rejection:', event.reason);
      event.preventDefault();
    });
  `}
</Script>
```

### 3. `next.config.js`
–£–ª—É—á—à–µ–Ω–∞ webpack –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:
```javascript
// –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –≤—ã–∑—ã–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã
config.resolve = config.resolve || {}
config.resolve.fallback = {
  ...config.resolve.fallback,
  fs: false,
  net: false,
  tls: false,
}
```

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### Dockerfile - –∑–∞—â–∏—Ç–∞ –æ—Ç —ç–∫—Å–ø–ª–æ–π—Ç–æ–≤
–î–æ–±–∞–≤–ª–µ–Ω—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ä—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:

```dockerfile
# üîí –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨: –£–¥–∞–ª—è–µ–º –æ–ø–∞—Å–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã
RUN rm -f /usr/bin/wget /usr/bin/curl /usr/bin/nc /usr/bin/netcat 2>/dev/null || true \
    && rm -rf /tmp/* /var/tmp/*

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ë–ï–ó postinstall —Å–∫—Ä–∏–ø—Ç–æ–≤
RUN npm ci --only=production --ignore-scripts
```

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–ü–µ—Ä–µ—Å–æ–±–µ—Ä–∏—Ç–µ Docker –æ–±—Ä–∞–∑** –ø–æ—Å–ª–µ —ç—Ç–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è** - —É–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ `NEXT_PUBLIC_API_URL` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ
3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - —Å–ª–µ–¥–∏—Ç–µ –∑–∞ –ª–æ–≥–∞–º–∏ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –æ—à–∏–±–∫–∏ –∏—Å—á–µ–∑–ª–∏

## –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏

```bash
# –í –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ frontend/frontend dir
docker build -t frontend-director:latest .

# –ò–ª–∏ —á–µ—Ä–µ–∑ docker-compose
docker-compose build frontend-director
```

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ - –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—à–∏–±–æ–∫ `returnNaN` –∏ `EACCES`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞–≥—Ä—É–∑–∫—É —Ñ–∞–π–ª–æ–≤ - –¥–æ–ª–∂–Ω—ã —Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ - –Ω–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å `uncaughtException`

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è

- Next.js –≤–µ—Ä—Å–∏—è: 15.5.5
- React –≤–µ—Ä—Å–∏—è: 18.3.1
- Node.js —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –≤–µ—Ä—Å–∏—è: 20.x

## –ö–æ–Ω—Ç–∞–∫—Ç—ã

–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç—Å—è, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:
1. –õ–æ–≥–∏ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
2. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
3. –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å auth-service –Ω–∞ –ø–æ—Ä—Ç—É 3002

